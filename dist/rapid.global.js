var rapid=function(t){"use strict";var e=(t=>(t.KEEP="keep",t.KEEP_H="keep_h",t.KEEP_W="keep_w",t.IGNORE="ignore",t.EXPAND="expand",t))(e||{}),i=(t=>(t.STRETCH="stretch",t.REPEAT="repeat",t))(i||{}),s=(t=>(t.REPEAT="repeat",t.CLAMP="clamp",t.MIRROR="mirror",t))(s||{}),r=(t=>(t.Include="normal",t.Exclude="inverse",t))(r||{}),n=(t=>(t.SQUARE="square",t.ISOMETRIC="isometric",t))(n||{}),o=(t=>(t.SPRITE="sprite",t.GRAPHIC="graphic",t))(o||{}),a=(t=>(t.Additive="additive",t.Subtractive="subtractive",t.Mix="mix",t))(a||{}),h=(t=>(t.POINT="point",t.CIRCLE="circle",t.RECT="rect",t))(h||{}),l=(t=>(t.STATIC="static",t.DYNAMIC="dynamic",t.KINEMATIC="kinematic",t))(l||{});var c=(t=>(t[t.Float32=0]="Float32",t[t.Uint32=1]="Uint32",t[t.Uint16=2]="Uint16",t))(c||{});class u{constructor(t){this.usedElemNum=0,this.maxElemNum=512,this.bytePerElem=this.getArrayType(t).BYTES_PER_ELEMENT,this.arrayType=t,this.arraybuffer=new ArrayBuffer(this.maxElemNum*this.bytePerElem),this.updateTypedArray()}getArrayType(t){switch(t){case 0:return Float32Array;case 1:return Uint32Array;case 2:return Uint16Array}}updateTypedArray(){switch(this.uint32=new Uint32Array(this.arraybuffer),this.float32=new Float32Array(this.arraybuffer),this.uint16=new Uint16Array(this.arraybuffer),this.arrayType){case 0:this.typedArray=this.float32;break;case 1:this.typedArray=this.uint32;break;case 2:this.typedArray=this.uint16}}clear(){this.usedElemNum=0}resize(t=0){if((t+=this.usedElemNum)>this.maxElemNum){for(;t>this.maxElemNum;)this.maxElemNum<<=1;this.setMaxSize(this.maxElemNum)}}setMaxSize(t=this.maxElemNum){const e=this.typedArray;this.maxElemNum=t,this.arraybuffer=new ArrayBuffer(t*this.bytePerElem),this.updateTypedArray(),this.typedArray.set(e)}pushUint32(t){this.uint32[this.usedElemNum++]=t}pushFloat32(t){this.float32[this.usedElemNum++]=t}pushUint16(t){this.uint16[this.usedElemNum++]=t}pop(t){this.usedElemNum-=t}getArray(t=0,e){return null==e?this.typedArray:this.typedArray.subarray(t,e)}get length(){return this.usedElemNum}}class d extends u{constructor(t,e,i=t.ARRAY_BUFFER,s=t.STATIC_DRAW){super(e),this.dirty=!0,this.webglBufferSize=0,this.gl=t,this.buffer=t.createBuffer(),this.type=i,this.usage=s}pushFloat32(t){super.pushFloat32(t),this.dirty=!0}pushUint32(t){super.pushUint32(t),this.dirty=!0}pushUint16(t){super.pushUint16(t),this.dirty=!0}bindBuffer(){this.gl.bindBuffer(this.type,this.buffer)}bufferData(){if(this.dirty){const t=this.gl;this.maxElemNum>this.webglBufferSize?(t.bufferData(this.type,this.getArray(),this.usage),this.webglBufferSize=this.maxElemNum):t.bufferSubData(this.type,0,this.getArray(0,this.usedElemNum)),this.dirty=!1}}}class p extends u{constructor(){super(0)}pushMat(){const t=this.usedElemNum-6,e=this.typedArray;this.resize(6),this.pushFloat32(e[t+0]),this.pushFloat32(e[t+1]),this.pushFloat32(e[t+2]),this.pushFloat32(e[t+3]),this.pushFloat32(e[t+4]),this.pushFloat32(e[t+5])}popMat(){this.pop(6)}pushIdentity(){this.resize(6),this.pushFloat32(1),this.pushFloat32(0),this.pushFloat32(0),this.pushFloat32(1),this.pushFloat32(0),this.pushFloat32(0)}translate(t,e){if("number"!=typeof t)return this.translate(t.x,t.y);const i=this.usedElemNum-6,s=this.typedArray;s[i+4]=s[i+0]*t+s[i+2]*e+s[i+4],s[i+5]=s[i+1]*t+s[i+3]*e+s[i+5]}rotate(t){const e=this.usedElemNum-6,i=this.typedArray,s=Math.cos(t),r=Math.sin(t),n=i[e+0],o=i[e+1],a=i[e+2],h=i[e+3];i[e+0]=n*s-o*r,i[e+1]=n*r+o*s,i[e+2]=a*s-h*r,i[e+3]=a*r+h*s}scale(t,e){if("number"!=typeof t)return this.scale(t.x,t.y);e||(e=t);const i=this.usedElemNum-6,s=this.typedArray;s[i+0]=s[i+0]*t,s[i+1]=s[i+1]*t,s[i+2]=s[i+2]*e,s[i+3]=s[i+3]*e}transformPoint(t,e){if("number"!=typeof t)return new x(...this.transformPoint(t.x,t.y));const i=this.usedElemNum-6,s=this.typedArray;return[s[i+0]*t+s[i+2]*e+s[i+4],s[i+1]*t+s[i+3]*e+s[i+5]]}getInverse(){const t=this.usedElemNum-6,e=this.typedArray,i=e[t+0],s=e[t+1],r=e[t+2],n=e[t+3],o=e[t+4],a=e[t+5],h=i*n-s*r;return new Float32Array([n/h,-s/h,-r/h,i/h,(r*a-n*o)/h,(s*o-i*a)/h])}getTransform(){const t=this.usedElemNum-6,e=this.typedArray;return new Float32Array([e[t+0],e[t+1],e[t+2],e[t+3],e[t+4],e[t+5]])}setTransform(t){const e=this.usedElemNum-6,i=this.typedArray;i[e+0]=t[0],i[e+1]=t[1],i[e+2]=t[2],i[e+3]=t[3],i[e+4]=t[4],i[e+5]=t[5]}getGlobalPosition(){const t=this.usedElemNum-6,e=this.typedArray;return new x(e[t+4],e[t+5])}setGlobalPosition(t,e){if("number"!=typeof t)return void this.setGlobalPosition(t.x,t.y);const i=this.usedElemNum-6,s=this.typedArray;s[i+4]=t,s[i+5]=e}getGlobalRotation(){const t=this.usedElemNum-6,e=this.typedArray;return Math.atan2(e[t+1],e[t+0])}setGlobalRotation(t){const e=this.usedElemNum-6,i=this.typedArray,s=this.getGlobalScale(),r=Math.cos(t),n=Math.sin(t);i[e+0]=r*s.x,i[e+1]=n*s.x,i[e+2]=-n*s.y,i[e+3]=r*s.y}getGlobalScale(){const t=this.usedElemNum-6,e=this.typedArray,i=Math.sqrt(e[t+0]*e[t+0]+e[t+1]*e[t+1]),s=Math.sqrt(e[t+2]*e[t+2]+e[t+3]*e[t+3]);return new x(i,s)}setGlobalScale(t,e){if("number"!=typeof t)return void this.setGlobalScale(t.x,t.y);const i=this.getGlobalRotation(),s=Math.cos(i),r=Math.sin(i),n=this.usedElemNum-6,o=this.typedArray;o[n+0]=s*t,o[n+1]=r*t,o[n+2]=-r*e,o[n+3]=s*e}globalToLocal(t){const e=this.getInverse();return new x(e[0]*t.x+e[2]*t.y+e[4],e[1]*t.x+e[3]*t.y+e[5])}localToGlobal(t){return this.transformPoint(t)}toCSSTransform(){const t=this.usedElemNum-6,e=this.typedArray;return`matrix(${e[t+0]}, ${e[t+1]}, ${e[t+2]}, ${e[t+3]}, ${e[t+4]}, ${e[t+5]})`}identity(){const t=this.usedElemNum-6,e=this.typedArray;e[t+0]=1,e[t+1]=0,e[t+2]=0,e[t+3]=1,e[t+4]=0,e[t+5]=0}applyTransform(t,e=0,i=0){(t.saveTransform??1)&&this.pushMat(),t.afterSave&&t.afterSave();const s=t.x||0,r=t.y||0;(s||r)&&this.translate(s,r),t.position&&this.translate(t.position),t.rotation&&this.rotate(t.rotation),t.scale&&this.scale(t.scale);let n=t.offsetX||0,o=t.offsetY||0;t.offset&&(n+=t.offset.x,o+=t.offset.y);const a=t.origin;return a&&("number"==typeof a?(n-=a*e,o-=a*i):(n-=a.x*e,o-=a.y*i)),{offsetX:n,offsetY:o}}applyTransformAfter(t){t.beforRestore&&t.beforRestore(),(t.restoreTransform??1)&&this.popMat()}}class f extends d{constructor(t,e,i,s){super(t,2,t.ELEMENT_ARRAY_BUFFER,t.STATIC_DRAW),this.setMaxSize(e*s);for(let r=0;r<s;r++)this.addObject(r*i);this.bindBuffer(),this.bufferData()}addObject(t){}}const m=class t{constructor(t,e,i,s=255){this._r=t,this._g=e,this._b=i,this._a=s,this.updateUint()}get r(){return this._r}set r(t){this._r=t,this.updateUint()}get g(){return this._g}set g(t){this._g=t,this.updateUint()}get b(){return this._b}set b(t){this._b=t,this.updateUint()}get a(){return this._a}set a(t){this._a=t,this.updateUint()}updateUint(){this.uint32=(this._a<<24|this._b<<16|this._g<<8|this._r)>>>0}setRGBA(t,e,i,s){this.r=t,this.g=e,this.b=i,this.a=s,this.updateUint()}copy(t){this.setRGBA(t.r,t.g,t.b,t.a)}clone(){return new t(this._r,this._g,this._b,this._a)}toHexString(t=!0){const e=this.r.toString(16).padStart(2,"0"),i=this.g.toString(16).padStart(2,"0"),s=this.b.toString(16).padStart(2,"0"),r=this.a.toString(16).padStart(2,"0");return`#${e}${i}${s}${t?r:""}`}equal(t){return t.r===this.r&&t.g===this.g&&t.b===this.b&&t.a===this.a}static fromHex(e){e.startsWith("#")&&(e=e.slice(1));const i=parseInt(e.slice(0,2),16),s=parseInt(e.slice(2,4),16),r=parseInt(e.slice(4,6),16);let n=255;return e.length>=8&&(n=parseInt(e.slice(6,8),16)),new t(i,s,r,n)}add(e){return new t(Math.min(this.r+e.r,255),Math.min(this.g+e.g,255),Math.min(this.b+e.b,255),Math.min(this.a+e.a,255))}subtract(e){return new t(Math.max(0,this.r-e.r),Math.max(0,this.g-e.g),Math.max(0,this.b-e.b),Math.max(0,this.a-e.a))}divide(e){return e instanceof t?new t(this.r/e.r,this.g/e.g,this.b/e.b,this.a/e.a):new t(this.r/e,this.g/e,this.b/e,this.a/e)}multiply(e){return e instanceof t?new t(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a):new t(this.r*e,this.g*e,this.b*e,this.a*e)}clamp(){this.r=Math.max(0,Math.min(255,this.r)),this.g=Math.max(0,Math.min(255,this.g)),this.b=Math.max(0,Math.min(255,this.b)),this.a=Math.max(0,Math.min(255,this.a))}};m.Red=new m(255,0,0,255),m.Green=new m(0,255,0,255),m.Blue=new m(0,0,255,255),m.Yellow=new m(255,255,0,255),m.Purple=new m(128,0,128,255),m.Orange=new m(255,165,0,255),m.Pink=new m(255,192,203,255),m.Gray=new m(128,128,128,255),m.Brown=new m(139,69,19,255),m.Cyan=new m(0,255,255,255),m.Magenta=new m(255,0,255,255),m.Lime=new m(192,255,0,255),m.White=new m(255,255,255,255),m.Black=new m(0,0,0,255),m.TRANSPARENT=new m(0,0,0,0);let g=m;const y=class t{constructor(t,e){this.x=void 0!==t?t:0,this.y=void 0!==e?e:0}set(t,e){return Array.isArray(t)?(this.x=t[0],this.y=t[1]):void 0!==e?(this.x=t,this.y=e):(this.x=t,this.y=t),this}add(e){return new t(this.x+e.x,this.y+e.y)}subtract(e){return new t(this.x-e.x,this.y-e.y)}multiply(e){return e instanceof t?new t(this.x*e.x,this.y*e.y):new t(this.x*e,this.y*e)}divide(e){return e instanceof t?new t(this.x/e.x,this.y/e.y):new t(this.x/e,this.y/e)}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}distanceTo(t){const e=this.x-t.x,i=this.y-t.y;return Math.sqrt(e*e+i*i)}clone(){return new t(this.x,this.y)}copy(t){this.x=t.x,this.y=t.y}equal(t){return t.x==this.x&&t.y==this.y}perpendicular(){const t=this.x;return this.x=-this.y,this.y=t,this}invert(){return this.x=-this.x,this.y=-this.y,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){const t=this.length();return this.x=this.x/t||0,this.y=this.y/t||0,this}angle(){return Math.atan2(this.y,this.x)}middle(e){return new t((this.x+e.x)/2,(this.y+e.y)/2)}abs(){return new t(Math.abs(this.x),Math.abs(this.y))}floor(){return new t(Math.floor(this.x),Math.floor(this.y))}ceil(){return new t(Math.ceil(this.x),Math.ceil(this.y))}snap(e){return new t(Math.round(this.x/e)*e,Math.round(this.y/e)*e)}stringify(){return`Vec2(${this.x}, ${this.y})`}static FromArray(e){return e.map((e=>new t(e[0],e[1])))}static fromAngle(e){return new t(Math.cos(e),Math.sin(e))}angleBetween(t){const e=this.dot(t),i=this.length()*t.length(),s=Math.max(-1,Math.min(1,e/i));return Math.acos(s)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}addSelf(t){return this.x+=t.x,this.y+=t.y,this}subtractSelf(t){return this.x-=t.x,this.y-=t.y,this}};y.ZERO=new y(0,0),y.ONE=new y(1,1),y.UP=new y(0,1),y.DOWN=new y(0,-1),y.LEFT=new y(-1,0),y.RIGHT=new y(1,0);let x=y;class T{static float(t,e){return Math.random()*(e-t)+t}static int(t,e){return Math.floor(Math.random()*(e-t+1))+t}static angle(){return Math.random()*Math.PI*2}static vector(t,e,i,s){return new x(T.float(t,e),T.float(i,s))}static direction(t){const e=T.angle();return new x(Math.cos(e)*t,Math.sin(e)*t)}static randomColor(t,e){return new g(T.float(t.r,e.r),T.float(t.g,e.g),T.float(t.b,e.b),T.float(t.a,e.a))}static pick(t){return t[T.int(0,t.length-1)]}static pickWeight(t){if(!t||0===t.length)return null;let e=0;for(const r of t)e+=r[1];const i=Math.random()*e;let s=0;for(const r of t)if(s+=r[1],i<=s)return r[0];return t[t.length-1][0]}static scalarOrRange(t,e){if(void 0===t)return e;if(Array.isArray(t)){if("number"==typeof t[0])return T.float(t[0],t[1]);if(t[0]instanceof x)return T.vector(t[0].x,t[1].x,t[0].y,t[1].y);if(t[0]instanceof g)return T.randomColor(t[0],t[1])}return"number"==typeof t?t:t.clone()}}class w{constructor(t){this.render=t}createLightShadowMaskPolygon(t,e,i){const s=[];t.forEach((t=>{for(let e=0;e<t.length;e++){const i=t[e],r=t[(e+1)%t.length];s.push([i,r])}})),i=i||Math.sqrt(Math.pow(this.render.width,2)+Math.pow(this.render.height,2));const r=[];return s.forEach((([t,s])=>{const n=new x(t.x-e.x,t.y-e.y),o=new x(s.x-e.x,s.y-e.y),a=s.subtract(t).perpendicular(),h=Math.abs(a.dot(n))/(a.length()*n.length())+.01,l=Math.abs(a.dot(o))/(a.length()*o.length())+.01,c=i/h,u=i/l,d=new x(n.x,n.y).normalize(),p=new x(o.x,o.y).normalize(),f=new x(t.x+d.x*c,t.y+d.y*c),m=new x(s.x+p.x*u,s.y+p.y*u);r.push([t,s,m,f])})),r}}const b=(t,e,i,s)=>{const r=[],n=s?Math.atan2(e.y,e.x):Math.atan2(-e.y,-e.x),o=Math.PI;for(let a=0;a<10;a++){const e=n+a/10*o,s=n+(a+1)/10*o,h=Math.cos(e)*i,l=Math.sin(e)*i,c=Math.cos(s)*i,u=Math.sin(s)*i;r.push(t),r.push(t.add(new x(h,l))),r.push(t.add(new x(c,u)))}return r},E=t=>{const e=t.points;if(e.length<2)return{vertices:[],uv:[]};const{normals:s,length:r}=((t,e=!1)=>{const i=[];if(t.length<2||e&&t.length<3)return{normals:i,length:0};const s=t.length;let r=0;if(e)for(let o=0;o<s;o++){const e=t[o],i=t[(o+1)%s];r+=e.distanceTo(i)}else for(let o=0;o<s-1;o++)r+=t[o].distanceTo(t[o+1]);const n=(t,e,i)=>{const s=e.subtract(t).normalize(),r=e.subtract(i).normalize(),n=r.dot(s);if(n<-.999)return{normal:s.perpendicular(),miters:1};{let t=r.add(s).normalize();s.cross(r)<0&&(t=t.multiply(-1));let e=1/Math.sqrt((1-n)/2);return{normal:t,miters:Math.min(e,4)}}};if(e){for(let e=0;e<s-1;e++){const r=0===e?t[s-2]:t[e-1],o=t[e],a=t[e+1];i.push(n(r,o,a))}i.push(i[0])}else for(let o=0;o<s;o++)if(0===o){const e=t[1].subtract(t[0]).normalize();i.push({normal:e.perpendicular(),miters:1})}else if(o===s-1){const e=t[o].subtract(t[o-1]).normalize();i.push({normal:e.perpendicular(),miters:1})}else i.push(n(t[o-1],t[o],t[o+1]));return{normals:i,length:r}})(e,t.closed),n=(t.width||1)/2,o=[],a=[],h=t.roundCap||!1,l=t.textureMode||i.STRETCH;let c=0;const u=t.texture?.width||1;for(let d=0;d<e.length-1;d++){const t=e[d],h=s[d].normal,p=s[d].miters,f=t.add(h.multiply(p*n)),m=t.subtract(h.multiply(p*n)),g=e[d+1],y=s[d+1].normal,T=s[d+1].miters,w=g.add(y.multiply(T*n)),b=g.subtract(y.multiply(T*n)),E=t.distanceTo(g);let R=0,v=0;l===i.STRETCH?(R=c/r,v=(c+E)/r):(R=c/u,v=R+E/u);const A=new x(R,0),S=new x(R,1),M=new x(v,0),C=new x(v,1);o.push(f),a.push(A),o.push(m),a.push(S),o.push(w),a.push(M),o.push(w),a.push(M),o.push(b),a.push(C),o.push(m),a.push(S),c+=E}if(h&&!t.closed){const t=e[0],i=s[0].normal,r=b(t,i,n,!0);o.push(...r);const a=e[e.length-1],h=s[e.length-1].normal,l=b(a,h,n,!1);o.push(...l)}return{vertices:o,uv:a}},R="precision mediump float;varying vec2 vRegion;varying vec4 vColor;uniform sampler2D uTexture;uniform int uUseTexture;void main(void){vec4 color;if(uUseTexture>0){color=texture2D(uTexture,vRegion)*vColor;}else{color=vColor;}gl_FragColor=color;}",v="precision mediump float;attribute vec2 aPosition;attribute vec4 aColor;attribute vec2 aRegion;varying vec4 vColor;uniform mat4 uProjectionMatrix;uniform vec4 uColor;varying vec2 vRegion;void main(void){gl_Position=uProjectionMatrix*vec4(aPosition,0.0,1.0);vColor=aColor;vRegion=aRegion;}",A=(t,e,i)=>{const s=t.createShader(i);if(!s)throw new Error("Unable to create webgl shader");t.shaderSource(s,e),t.compileShader(s);if(!t.getShaderParameter(s,t.COMPILE_STATUS)){const i=t.getShaderInfoLog(s);throw console.error("Shader compilation failed:",i),new Error("Unable to compile shader: "+i+e)}return s};function S(t,e,i,s=!1,r=!1,n="clamp"){const o=t.createTexture();if(!o)throw new Error("unable to create texture");let a;switch(t.bindTexture(t.TEXTURE_2D,o),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,i?t.LINEAR:t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,i?t.LINEAR:t.NEAREST),n){case"repeat":a=t.REPEAT;break;case"mirror":a=t.MIRRORED_REPEAT;break;default:a=t.CLAMP_TO_EDGE}return t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,a),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,a),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,r),s?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e.width,e.height,0,t.RGBA,t.UNSIGNED_BYTE,null):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),o}const M=5126,C="precision mediump float;uniform sampler2D uTextures[%TEXTURE_NUM%];varying vec2 vRegion;varying float vTextureId;varying vec4 vColor;void main(void){vec4 color;%GET_COLOR%gl_FragColor=color*vColor;}",P="precision mediump float;attribute vec2 aPosition;attribute vec2 aRegion;attribute float aTextureId;attribute vec4 aColor;uniform mat4 uProjectionMatrix;varying vec2 vRegion;varying float vTextureId;varying vec4 vColor;void main(void){vRegion=aRegion;vTextureId=aTextureId;vColor=aColor;gl_Position=uProjectionMatrix*vec4(aPosition,0.0,1.0);}",_=[{name:"aPosition",size:2,type:M,stride:24},{name:"aRegion",size:2,type:M,stride:24,offset:2*Float32Array.BYTES_PER_ELEMENT},{name:"aTextureId",size:1,type:M,stride:24,offset:4*Float32Array.BYTES_PER_ELEMENT},{name:"aColor",size:4,type:5121,stride:24,offset:5*Float32Array.BYTES_PER_ELEMENT,normalized:!0}],U=[{name:"aPosition",size:2,type:M,stride:20},{name:"aColor",size:4,type:5121,stride:20,offset:2*Float32Array.BYTES_PER_ELEMENT,normalized:!0},{name:"aRegion",size:2,type:M,stride:20,offset:3*Float32Array.BYTES_PER_ELEMENT}];class F{constructor(t,e,i,s,r=0){this.attributeLoc={},this.uniformLoc={},this.textureUnitNum=0,this.attributes=[];const n=function(t,e){if(t.includes("%TEXTURE_NUM%")&&(t=t.replace("%TEXTURE_NUM%",e.toString())),t.includes("%GET_COLOR%")){let i="";for(let t=0;t<e;t++)i+=0==t?`if(vTextureId == ${t}.0)`:t==e-1?"else":`else if(vTextureId == ${t}.0)`,i+=`{color = texture2D(uTextures[${t}], vRegion);}`;t=t.replace("%GET_COLOR%",i)}return t}(i,t.maxTextureUnits-r);this.program=((t,e,i)=>{var s=t.createProgram(),r=A(t,e,35633),n=A(t,i,35632);if(!s)throw new Error("Unable to create program shader");if(t.attachShader(s,r),t.attachShader(s,n),t.linkProgram(s),!t.getProgramParameter(s,t.LINK_STATUS)){const e=t.getProgramInfoLog(s);throw new Error("Unable to link shader program: "+e)}return s})(t.gl,e,n),this.gl=t.gl,this.textureUnitNum=r,this.parseShader(e),this.parseShader(n),s&&this.setAttributes(s)}setUniforms(t,e){const i=this.gl;for(const s of t.getUnifromNames()){const r=this.getUniform(s);t.bind(i,s,r,e)}}getUniform(t){return this.uniformLoc[t]}use(){this.gl.useProgram(this.program)}parseShader(t){const e=this.gl,i=t.match(/attribute\s+\w+\s+(\w+)/g);if(i)for(const r of i){const t=r.split(" ")[2],i=e.getAttribLocation(this.program,t);-1!=i&&(this.attributeLoc[t]=i)}const s=t.match(/uniform\s+\w+\s+(\w+)/g);if(s)for(const r of s){const t=r.split(" ")[2];this.uniformLoc[t]=e.getUniformLocation(this.program,t)}}setAttribute(t){const e=this.attributeLoc[t.name];if(void 0!==e){const i=this.gl;i.vertexAttribPointer(e,t.size,t.type,t.normalized||!1,t.stride,t.offset||0),i.enableVertexAttribArray(e)}}setAttributes(t){this.attributes=t;for(const e of t)this.setAttribute(e)}updateAttributes(){this.setAttributes(this.attributes)}static createCostumShader(t,e,i,s,r=0){let n={[o.SPRITE]:C,[o.GRAPHIC]:R}[s],a={[o.SPRITE]:P,[o.GRAPHIC]:v}[s];const h={[o.SPRITE]:_,[o.GRAPHIC]:U}[s];return n=n.replace("void main(void) {",i+"\nvoid main(void) {"),a=a.replace("void main(void) {",e+"\nvoid main(void) {"),n=n.replace("// fragment","fragment(color);"),a=a.replace(/\/\/ vertex s[\s\S]*?\/\/ vertex e/,"vec2 position = aPosition;\n            vertex(position, vRegion);\n            gl_Position = uProjectionMatrix * vec4(position, 0.0, 1.0);"),new F(t,a,n,h,r)}}class N{constructor(t){this.usedTextures=[],this.shaders=new Map,this.isCostumShader=!1,this.freeTextureUnitNum=0,this.rapid=t,this.gl=t.gl,this.webglArrayBuffer=new d(t.gl,c.Float32,t.gl.ARRAY_BUFFER,t.gl.STREAM_DRAW),this.maxTextureUnits=t.maxTextureUnits}getTextureUnitList(){return Array.from({length:this.maxTextureUnits},((t,e)=>e))}addVertex(t,e,...i){const[s,r]=this.rapid.matrixStack.transformPoint(t,e);this.webglArrayBuffer.pushFloat32(s),this.webglArrayBuffer.pushFloat32(r)}useTexture(t){const e=this.usedTextures.indexOf(t);return-1==e?(this.usedTextures.push(t),this.freeTextureUnitNum=this.maxTextureUnits-this.usedTextures.length,[this.usedTextures.length-1,!0]):[e,!1]}enterRegion(t){this.currentShader=t??this.getShader("default"),this.currentShader.use(),this.initializeForNextRender(),this.webglArrayBuffer.bindBuffer(),this.currentShader.updateAttributes(),this.updateProjection(),this.isCostumShader=Boolean(t)}updateProjection(){this.gl.uniformMatrix4fv(this.currentShader.uniformLoc.uProjectionMatrix,!1,this.rapid.projection)}isUnifromChanged(t){return!!t&&(this.costumUnifrom!=t||!!t?.isDirty)}setCurrentUniform(t){t.clearDirty(),this.costumUnifrom=t}exitRegion(){}initDefaultShader(t,e,i){this.setShader("default",t,e,i)}setShader(t,e,i,s){this.webglArrayBuffer.bindBuffer(),this.shaders.set(t,new F(this.rapid,e,i,s)),"default"===t&&(this.defaultShader=this.shaders.get(t))}getShader(t){return this.shaders.get(t)}render(){this.executeRender(),this.initializeForNextRender()}executeRender(){const t=this.gl;for(let e=0;e<this.usedTextures.length;e++)t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_2D,this.usedTextures[e]);this.webglArrayBuffer.bufferData()}initializeForNextRender(){this.webglArrayBuffer.clear(),this.usedTextures.length=0,this.isCostumShader=!1,this.freeTextureUnitNum=this.maxTextureUnits}hasPendingContent(){return!1}isShaderChanged(t){return(t||this.defaultShader)!=this.currentShader}}class D extends N{constructor(t){super(t),this.vertex=0,this.offset=x.ZERO,this.drawType=t.gl.TRIANGLE_FAN,this.setShader("default",v,R,U)}startRender(t,e,i,s){s&&this.currentShader?.setUniforms(s,this),this.offset=new x(t,e),this.vertex=0,this.webglArrayBuffer.clear(),i&&i.base&&(this.texture=this.useTexture(i.base.texture)[0])}addVertex(t,e,i,s,r){this.webglArrayBuffer.resize(3),super.addVertex(t+this.offset.x,e+this.offset.y),this.webglArrayBuffer.pushUint32(r),this.webglArrayBuffer.pushFloat32(i),this.webglArrayBuffer.pushFloat32(s),this.vertex+=1}executeRender(){super.executeRender();const t=this.gl;t.uniform1i(this.currentShader.uniformLoc.uUseTexture,void 0===this.texture?0:1),this.texture&&t.uniform1i(this.currentShader.uniformLoc.uTexture,this.texture),t.drawArrays(this.drawType,0,this.vertex),this.drawType=this.rapid.gl.TRIANGLE_FAN,this.vertex=0,this.texture=void 0}}const L=Math.floor(16384);class I extends f{constructor(t,e){super(t,6,4,e)}addObject(t){super.addObject(),this.pushUint16(t),this.pushUint16(t+1),this.pushUint16(t+2),this.pushUint16(t),this.pushUint16(t+3),this.pushUint16(t+2)}}class B extends N{constructor(t){const e=t.gl;super(t),this.batchSprite=0,this.spriteTextureUnits=[],this.spriteTextureUnitIndexOffset=0,this.setShader("default",P,C,_),this.indexBuffer=new I(e,L)}addVertex(t,e,i,s,r,n){super.addVertex(t,e),this.webglArrayBuffer.pushFloat32(i),this.webglArrayBuffer.pushFloat32(s),this.webglArrayBuffer.pushFloat32(r),this.webglArrayBuffer.pushUint32(n)}renderSprite(t,e,i,s,r,n,o,a,h,l,c,u,d,p=0){(1+p>this.freeTextureUnitNum||this.batchSprite>=L||this.isUnifromChanged(c)||this.rapid.projectionDirty)&&(this.render(),c&&this.isUnifromChanged(c)&&(this.currentShader.setUniforms(c,this),this.setCurrentUniform(c)),this.rapid.projectionDirty&&this.updateProjection()),this.batchSprite++,this.webglArrayBuffer.resize(20);const[f,m]=this.useTexture(t);m&&(this.spriteTextureUnits.push(f),this.spriteTextureUnitIndexOffset=this.spriteTextureUnits[0]);const g=f-this.spriteTextureUnitIndexOffset,y=u?n:s,x=u?s:n,T=d?o:r,w=d?r:o,b=a,E=a+e,R=h,v=h+i;this.addVertex(b,R,y,T,g,l),this.addVertex(E,R,x,T,g,l),this.addVertex(E,v,x,w,g,l),this.addVertex(b,v,y,w,g,l)}executeRender(){if(super.executeRender(),this.batchSprite<=0)return;const t=this.gl;this.spriteTextureUnits.length>0&&this.gl.uniform1iv(this.currentShader.uniformLoc.uTextures,this.spriteTextureUnits),t.drawElements(t.TRIANGLES,6*this.batchSprite,t.UNSIGNED_SHORT,0)}enterRegion(t){super.enterRegion(t),this.indexBuffer.bindBuffer()}initializeForNextRender(){super.initializeForNextRender(),this.batchSprite=0,this.spriteTextureUnits.length=0}hasPendingContent(){return this.batchSprite>0}}class k{constructor(t,e){this.cache=new Map,this.render=t,this.antialias=e}async textureFromUrl(t,e=this.antialias,i=s.CLAMP){let r=this.cache.get(t);if(!r){const s=await this.loadImage(t);r=O.fromImageSource(this.render,s,e,i),r.cacheKey=t,this.cache.set(t,r)}return new G(r)}textureFromFrameBufferObject(t){return new G(t)}textureFromSource(t,e=this.antialias,i=s.CLAMP){let r=this.cache.get(t);return r||(r=O.fromImageSource(this.render,t,e,i),r.cacheKey=t,this.cache.set(t,r)),new G(r)}async loadImage(t){return new Promise((e=>{const i=new Image;i.onload=()=>{e(i)},i.src=t}))}createText(t){return new W(this.render,t)}destroy(t){const e=t instanceof G?t.base:t;e&&(e.destroy(this.render.gl),this.removeCache(e))}createFrameBufferObject(t,e,i=this.antialias){return new j(this.render,t,e,i)}removeCache(t){t.cacheKey&&this.cache.delete(t.cacheKey)}}class O{constructor(t,e,i,r=s.CLAMP){this.cacheKey=null,this.texture=t,this.width=e,this.height=i,this.wrapMode=r}static fromImageSource(t,e,i=!1,r=s.CLAMP){return new O(S(t.gl,e,i,!1,!1,r),e.width,e.height)}destroy(t){t.deleteTexture(this.texture)}}class G{constructor(t){this.scale=1,this.setBaseTexture(t)}setBaseTexture(t){t&&(this.base=t,this.setClipRegion(0,0,t.width,t.height))}setClipRegion(t,e,i,s){if(this.base)return this.clipX=t/this.base.width,this.clipY=e/this.base.height,this.clipW=this.clipX+i/this.base.width,this.clipH=this.clipY+s/this.base.height,this.width=i*this.scale,this.height=s*this.scale,this}static fromImageSource(t,e,i=!1){return new G(O.fromImageSource(t,e,i))}static fromFrameBufferObject(t){return new G(t)}createSpritesheet(t,e){if(!this.base)return[];const i=[],s=Math.floor(this.base.width/t),r=Math.floor(this.base.height/e);for(let n=0;n<r;n++)for(let r=0;r<s;r++){const s=this.clone();s.setClipRegion(r*t,n*e,t,e),i.push(s)}return i}clone(){return new G(this.base)}}const z=2.5;class W extends G{constructor(t,e){super(),this.scale=.4,this.rapid=t,this.options=e,this.text=e.text||" ",this.updateTextImage()}updateTextImage(){this.base&&this.base.destroy(this.rapid.gl);const t=this.createTextCanvas();this.setBaseTexture(O.fromImageSource(this.rapid,t,!0))}createTextCanvas(){const t=document.createElement("canvas"),e=t.getContext("2d");if(!e)throw new Error("Failed to get 2D canvas context");const i=this.options.fontSize||16,s=`${i}px ${this.options.fontFamily||"Arial"}`,r=this.text.split("\n");e.font=s;let n=0;for(const h of r){const t=e.measureText(h);n=Math.max(n,t.width)}const o=i*r.length;t.width=Math.ceil(n)*z,t.height=Math.ceil(o)*z,e.scale(z,z),e.font=s,e.fillStyle=this.options.color?this.options.color.toHexString():"#000",e.textAlign=this.options.textAlign||"left",e.textBaseline=this.options.textBaseline||"top";let a=0;for(const h of r)e.fillText(h,0,a),a+=i;return t}setText(t){this.text!==t&&(this.text=t||" ",this.updateTextImage())}}class j extends O{constructor(t,e,i,s=!1){const r=t.gl,n=S(r,{width:e,height:i},s,!0,!1),o=r.createFramebuffer();if(!o)throw r.deleteTexture(n),new Error("Failed to create WebGL framebuffer");r.bindFramebuffer(r.FRAMEBUFFER,o),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,n,0);const a=r.createRenderbuffer();if(!a)throw r.deleteFramebuffer(o),r.deleteTexture(n),new Error("Failed to create depth-stencil renderbuffer");r.bindRenderbuffer(r.RENDERBUFFER,a),r.renderbufferStorage(r.RENDERBUFFER,r.STENCIL_INDEX8,e,i),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.STENCIL_ATTACHMENT,r.RENDERBUFFER,a),super(n,e,i),this.gl=r,this.framebuffer=o,this.stencilBuffer=a,r.bindTexture(r.TEXTURE_2D,null),r.bindFramebuffer(r.FRAMEBUFFER,null),r.bindRenderbuffer(r.RENDERBUFFER,null)}bind(t){const e=this.gl;e.bindTexture(e.TEXTURE_2D,null),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer),e.clearColor(t.r,t.g,t.b,t.a),e.clear(e.COLOR_BUFFER_BIT|e.STENCIL_BUFFER_BIT)}unbind(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.bindTexture(this.gl.TEXTURE_2D,null)}resize(t,e){if(this.width===t&&this.height===e)return;this.width=t,this.height=e;const i=this.gl;i.bindTexture(i.TEXTURE_2D,this.texture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,e,0,i.RGBA,i.UNSIGNED_BYTE,null),i.bindTexture(i.TEXTURE_2D,null),i.bindRenderbuffer(i.RENDERBUFFER,this.stencilBuffer),i.renderbufferStorage(i.RENDERBUFFER,i.STENCIL_INDEX8,t,e),i.bindRenderbuffer(i.RENDERBUFFER,null)}destroy(t){t.deleteFramebuffer(this.framebuffer),t.deleteRenderbuffer(this.stencilBuffer),super.destroy(t)}}function X(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Y,H={exports:{}};var $=(Y||(Y=1,function(t){var e=Object.prototype.hasOwnProperty,i="~";function s(){}function r(t,e,i){this.fn=t,this.context=e,this.once=i||!1}function n(t,e,s,n,o){if("function"!=typeof s)throw new TypeError("The listener must be a function");var a=new r(s,n||t,o),h=i?i+e:e;return t._events[h]?t._events[h].fn?t._events[h]=[t._events[h],a]:t._events[h].push(a):(t._events[h]=a,t._eventsCount++),t}function o(t,e){0==--t._eventsCount?t._events=new s:delete t._events[e]}function a(){this._events=new s,this._eventsCount=0}Object.create&&(s.prototype=Object.create(null),(new s).__proto__||(i=!1)),a.prototype.eventNames=function(){var t,s,r=[];if(0===this._eventsCount)return r;for(s in t=this._events)e.call(t,s)&&r.push(i?s.slice(1):s);return Object.getOwnPropertySymbols?r.concat(Object.getOwnPropertySymbols(t)):r},a.prototype.listeners=function(t){var e=i?i+t:t,s=this._events[e];if(!s)return[];if(s.fn)return[s.fn];for(var r=0,n=s.length,o=new Array(n);r<n;r++)o[r]=s[r].fn;return o},a.prototype.listenerCount=function(t){var e=i?i+t:t,s=this._events[e];return s?s.fn?1:s.length:0},a.prototype.emit=function(t,e,s,r,n,o){var a=i?i+t:t;if(!this._events[a])return!1;var h,l,c=this._events[a],u=arguments.length;if(c.fn){switch(c.once&&this.removeListener(t,c.fn,void 0,!0),u){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,e),!0;case 3:return c.fn.call(c.context,e,s),!0;case 4:return c.fn.call(c.context,e,s,r),!0;case 5:return c.fn.call(c.context,e,s,r,n),!0;case 6:return c.fn.call(c.context,e,s,r,n,o),!0}for(l=1,h=new Array(u-1);l<u;l++)h[l-1]=arguments[l];c.fn.apply(c.context,h)}else{var d,p=c.length;for(l=0;l<p;l++)switch(c[l].once&&this.removeListener(t,c[l].fn,void 0,!0),u){case 1:c[l].fn.call(c[l].context);break;case 2:c[l].fn.call(c[l].context,e);break;case 3:c[l].fn.call(c[l].context,e,s);break;case 4:c[l].fn.call(c[l].context,e,s,r);break;default:if(!h)for(d=1,h=new Array(u-1);d<u;d++)h[d-1]=arguments[d];c[l].fn.apply(c[l].context,h)}}return!0},a.prototype.on=function(t,e,i){return n(this,t,e,i,!1)},a.prototype.once=function(t,e,i){return n(this,t,e,i,!0)},a.prototype.removeListener=function(t,e,s,r){var n=i?i+t:t;if(!this._events[n])return this;if(!e)return o(this,n),this;var a=this._events[n];if(a.fn)a.fn!==e||r&&!a.once||s&&a.context!==s||o(this,n);else{for(var h=0,l=[],c=a.length;h<c;h++)(a[h].fn!==e||r&&!a[h].once||s&&a[h].context!==s)&&l.push(a[h]);l.length?this._events[n]=1===l.length?l[0]:l:o(this,n)}return this},a.prototype.removeAllListeners=function(t){var e;return t?(e=i?i+t:t,this._events[e]&&o(this,e)):(this._events=new s,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=i,a.EventEmitter=a,t.exports=a}(H)),H.exports);const K=X($);class V extends K{constructor(t){super(),this.totalAsset=0,this.loadedAssets=0,this.game=t,this.assets={json:{},audio:{},images:{}}}loadJson(t,e){this.totalAsset++,fetch(e).then((t=>{if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t.json()})).then((e=>{this.assets.json[t]=e,this.assetLoaded()})).catch((i=>this.handleError(t,e,i)))}async loadAudio(t,e){this.totalAsset++;try{const i=await this.game.audio.audioFromUrl(e);this.assets.audio[t]=i,this.assetLoaded()}catch(i){this.handleError(t,e,i),this.assetLoaded()}}async loadImage(t,e){this.totalAsset++;try{this.assets.images[t]=await this.game.render.texture.textureFromUrl(e),this.assetLoaded()}catch(i){this.handleError(t,e,i),this.assetLoaded()}}loadAssets(t){if(0===t.length)return this.emit("progress",1,0,0),void this.emit("complete",this.assets);t.forEach((t=>{switch(t.type){case"json":this.loadJson(t.name,t.url);break;case"audio":this.loadAudio(t.name,t.url);break;case"image":this.loadImage(t.name,t.url);break;default:console.warn(`Unknown asset type: ${t.type}`)}}))}assetLoaded(){this.loadedAssets++;const t=this.totalAsset>0?this.loadedAssets/this.totalAsset:1;this.emit("progress",t,this.loadedAssets,this.totalAsset),this.loadedAssets>=this.totalAsset&&this.emit("complete",this.assets)}handleError(t,e,i){this.emit("error",{name:t,url:e,error:i}),console.error(`Failed to load asset '${t}' from ${e}:`,i)}get(t,e){return this.assets[t]?.[e]}getJSON(t){return this.assets.json[t]}getAudio(t){return this.assets.audio[t]}getTexture(t){return this.assets.images[t]}}class q extends K{constructor(t,e){super(),this.sourceNode=null,this._volume=1,this._loop=!1,this._isPlaying=!1,this.audioContext=t,this.audioBuffer=e,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination)}play(){this.audioContext&&this.audioBuffer&&this.gainNode?(this._isPlaying&&this.stop(),this.sourceNode=this.audioContext.createBufferSource(),this.sourceNode.buffer=this.audioBuffer,this.sourceNode.loop=this._loop,this.sourceNode.connect(this.gainNode),this.sourceNode.onended=()=>{this._isPlaying&&(this._isPlaying=!1,this.sourceNode=null,this.emit("ended"))},this.sourceNode.start(0),this._isPlaying=!0):console.warn("Cannot play audio on a destroyed AudioPlayer.")}stop(){this.sourceNode&&this.sourceNode.stop(),this._isPlaying=!1}get volume(){return this._volume}set volume(t){this._volume=Math.max(0,Math.min(1,t)),this.gainNode&&this.audioContext&&this.gainNode.gain.setTargetAtTime(this._volume,this.audioContext.currentTime,.01)}get loop(){return this._loop}set loop(t){this._loop=t,this.sourceNode&&(this.sourceNode.loop=t)}get isPlaying(){return this._isPlaying}destroy(){this.stop(),this.gainNode&&this.gainNode.disconnect(),this.removeAllListeners(),this.audioBuffer=null,this.audioContext=null,this.gainNode=null,this.sourceNode=null}}class Q{constructor(){this.cache=new Map;try{this.audioContext=new(window.AudioContext||window.webkitAudioContext)}catch(t){console.error("Web Audio API is not supported in this browser."),this.audioContext=null}}async audioFromUrl(t){if(!this.audioContext)throw new Error("AudioContext is not available. Cannot process audio.");let e=this.cache.get(t);if(!e){const s=await fetch(t);if(!s.ok)throw new Error(`Failed to fetch audio from ${t}: ${s.statusText}`);const r=await s.arrayBuffer();try{e=await this.audioContext.decodeAudioData(r)}catch(i){throw new Error(`Failed to decode audio from ${t}: ${i}`)}this.cache.set(t,e)}return new q(this.audioContext,e)}destroy(){this.cache.clear(),this.audioContext&&"closed"!==this.audioContext.state&&this.audioContext.close().catch((t=>{console.error("Error closing AudioContext:",t)})),this.audioContext=null}}class Z{constructor(t){this.mousePosition=x.ZERO,this.keysDown=new Set,this.keysDownLastFrame=new Set,this.buttonsDown=new Set,this.buttonsDownLastFrame=new Set,this.rapid=t,this.canvas=t.canvas,this.attachEventListeners()}attachEventListeners(){const t=this.canvas.getBoundingClientRect();this.canvas.addEventListener("mousemove",this.handleMouseMove=e=>{this.mousePosition=this.rapid.cssToGameCoords(e.clientX-t.left,e.clientY-t.top)}),window.addEventListener("keydown",this.handleKeyDown=t=>{this.keysDown.add(t.code)}),window.addEventListener("keyup",this.handleKeyUp=t=>{this.keysDown.delete(t.code)}),this.canvas.addEventListener("mousedown",this.handleMouseDown=t=>{this.buttonsDown.add(t.button)}),this.canvas.addEventListener("mouseup",this.handleMouseUp=t=>{this.buttonsDown.delete(t.button)})}updateNextFrame(){this.keysDownLastFrame=new Set(this.keysDown),this.buttonsDownLastFrame=new Set(this.buttonsDown)}isKeyDown(t){return this.keysDown.has(t)}isKeyUp(t){return!this.keysDown.has(t)}wasKeyPressed(t){return this.keysDown.has(t)&&!this.keysDownLastFrame.has(t)}wasKeyReleased(t){return!this.keysDown.has(t)&&this.keysDownLastFrame.has(t)}isButtonDown(t){return this.buttonsDown.has(t)}isButtonUp(t){return!this.buttonsDown.has(t)}wasButtonPressed(t){return this.buttonsDown.has(t)&&!this.buttonsDownLastFrame.has(t)}wasButtonReleased(t){return!this.buttonsDown.has(t)&&this.buttonsDownLastFrame.has(t)}getMouseLocal(t){return t.transform.globalToLocal(this.mousePosition)}getAxis(t,e){let i=0;return this.isKeyDown(e)&&(i+=1),this.isKeyDown(t)&&(i-=1),i}getVector(t,e,i,s){const r=this.getAxis(t,e),n=this.getAxis(i,s);return new x(r,n).normalize()}destroy(){this.canvas.removeEventListener("mousemove",this.handleMouseMove),window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp),this.canvas.removeEventListener("mousedown",this.handleMouseDown),this.canvas.removeEventListener("mouseup",this.handleMouseUp),this.keysDown.clear(),this.keysDownLastFrame.clear(),this.buttonsDown.clear(),this.buttonsDownLastFrame.clear()}}class J extends K{constructor(t,e,i,s,r){super(),this.elapsed=0,this.isRunning=!1,this.isFinished=!1,this.target=t,this.property=e,this.to=i,this.duration=s,this.easing=r}start(){const t=this.target[this.property];if("number"==typeof t)this.from=t;else{if("function"!=typeof t.clone)return console.error("Tween target property is not a 'number' or does not have a 'clone' method."),void(this.isFinished=!0);this.from=t.clone()}this.elapsed=0,this.isRunning=!0,this.isFinished=!1}update(t){if(!this.isRunning||this.isFinished)return;this.elapsed+=t;const e=Math.min(this.elapsed/this.duration,1),i=this.easing(e);let s;if("number"==typeof this.from&&"number"==typeof this.to)s=this.from+(this.to-this.from)*i;else{const t=this.from,e=this.to.subtract(t).multiply(i);s=t.add(e)}this.target[this.property]=s,e>=1&&(this.isFinished=!0,this.isRunning=!1,this.target[this.property]=this.to,this.emit("complete"))}}const tt=class{};tt.Linear=t=>t,tt.EaseInQuad=t=>t*t,tt.EaseOutQuad=t=>t*(2-t),tt.EaseInOutQuad=t=>t<.5?2*t*t:(4-2*t)*t-1,tt.EaseInCubic=t=>t*t*t,tt.EaseOutCubic=t=>--t*t*t+1,tt.EaseInOutCubic=t=>t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1,tt.EaseInQuart=t=>t*t*t*t,tt.EaseOutQuart=t=>1- --t*t*t*t,tt.EaseInOutQuart=t=>t<.5?8*t*t*t*t:1-8*--t*t*t*t;let et=tt;class it extends K{constructor(t,e=!1){super(),this.elapsedTime=0,this.isRunning=!1,this.isFinished=!1,this.duration=t,this.repeat=e}start(){this.isRunning=!0}stop(){this.isRunning=!1}update(t){this.isRunning&&!this.isFinished&&(this.elapsedTime+=t,this.elapsedTime>=this.duration&&(this.emit("timeout"),this.repeat?this.elapsedTime-=this.duration:(this.isFinished=!0,this.isRunning=!1)))}destroy(){this.isFinished=!0,this.isRunning=!1}}class st{constructor(t,e=new x(0,0)){this.entity=t instanceof ut?t.entity:t,this.offset=e}getWorldPosition(){return this.entity.updateTransform(!0),this.entity.transform.transformPoint(this.offset)}}class rt extends st{constructor(t,e,i){super(t,i),this.radius=e}getWorldRadius(){const t=this.entity.scale;return this.radius*Math.max(Math.abs(t.x),Math.abs(t.y))}}class nt extends st{constructor(t,e,i){super(t,i),this.localVertices=e}getWorldVertices(){this.entity.updateTransform(!0);const t=this.entity.transform;return this.localVertices.map((e=>t.transformPoint(e.add(this.offset))))}getAxes(){const t=this.getWorldVertices(),e=[];for(let i=0;i<t.length;i++){const s=t[i],r=(t[i+1]||t[0]).subtract(s),n=new x(-r.y,r.x).normalize();let o=!0;for(const t of e)if(Math.abs(t.dot(n))>.9999){o=!1;break}o&&e.push(n)}return e}}function ot(t,e){let i=1/0,s=-1/0;for(const r of t){const t=r.dot(e);t<i&&(i=t),t>s&&(s=t)}return{min:i,max:s}}function at(t,e,i){const s=t.dot(i);return{min:s-e,max:s+e}}function ht(t,e){const i=t.getWorldVertices(),s=t.getAxes(),r=e.getWorldPosition(),n=e.getWorldRadius();let o=i[0],a=1/0;for(const u of i){const t=r.distanceTo(u)**2;t<a&&(a=t,o=u)}const h=o.subtract(r);h.length()>1e-9&&s.push(h.normalize());let l=1/0,c=null;for(const u of s){const t=ot(i,u),e=at(r,n,u),s=Math.min(t.max,e.max)-Math.max(t.min,e.min);if(s<=0)return{collided:!1};s<l&&(l=s,c=u)}if(!c)return{collided:!1};return t.getWorldPosition().subtract(r).dot(c)<0&&c.invert(),{collided:!0,mtv:c.multiply(l)}}function lt(t,e){if(!t||!e||t.entity===e.entity)return{collided:!1};if(t instanceof nt){if(e instanceof nt)return function(t,e){const i=t.getAxes().concat(e.getAxes());let s=1/0,r=null;for(const n of i){const i=ot(t.getWorldVertices(),n),o=ot(e.getWorldVertices(),n),a=Math.min(i.max,o.max)-Math.max(i.min,o.min);if(a<=0)return{collided:!1};a<s&&(s=a,r=n)}return r?(t.getWorldPosition().subtract(e.getWorldPosition()).dot(r)<0&&r.invert(),{collided:!0,mtv:r.multiply(s)}):{collided:!1}}(t,e);if(e instanceof rt)return ht(t,e)}else if(t instanceof rt){if(e instanceof nt){const i=ht(e,t);return i.mtv&&i.mtv.invert(),i}if(e instanceof rt)return function(t,e){const i=t.getWorldPosition(),s=e.getWorldPosition(),r=t.getWorldRadius(),n=e.getWorldRadius(),o=i.subtract(s),a=o.x*o.x+o.y*o.y,h=r+n;if(a>=h*h)return{collided:!1};const l=Math.sqrt(a),c=h-l;return 0===l?{collided:!0,mtv:new x(c,0)}:{collided:!0,mtv:o.normalize().multiply(c)}}(t,e)}return{collided:!1}}class ct{constructor(t){this.components=new Set,this.game=t}addComponent(t){this.components.add(t)}removeComponent(t){this.components.delete(t)}onPhysics(t){const e=Array.from(this.components);if(e.length<2)return;const i=new Map;e.forEach((t=>i.set(t,[])));for(let s=0;s<e.length;s++)for(let t=s+1;t<e.length;t++){const r=e[s],n=e[t];if(!r.disabled&&!n.disabled)for(const t of r.colliders)for(const e of n.colliders){const s=lt(t,e);if(s.collided){const o=s.mtv,a=o.clone().invert();i.get(r).push({colliderA:t,colliderB:e,mtv:o,otherEntity:n.entity}),i.get(n).push({colliderA:e,colliderB:t,mtv:a,otherEntity:r.entity})}}}for(const s of this.components){const t=i.get(s),e=s.activeCollisions,r=new Map;for(const i of t)r.has(i.otherEntity)||r.set(i.otherEntity,[]),r.get(i.otherEntity).push(i);for(const[i,n]of r.entries())e.has(i)||s.onBodyEnter?.(i,n);for(const i of e.keys())r.has(i)||s.onBodyExit?.(i);s.activeCollisions=r}}}class ut extends dt{constructor(t){super(t),this.colliders=[],this.activeCollisions=new Map,this.velocity=x.ZERO,this.acceleration=x.ZERO,this.disabled=!1,this.bodyType=t.bodyType??l.STATIC}getCollidedObjects(){return this.activeCollisions.keys()}onAttach(t){super.onAttach(t);const e=this.options;this.colliders.length=0,Array.isArray(e.colliders)?this.colliders.push(...e.colliders):this.colliders.push(e.colliders),this.game.physics.addComponent(this)}onDetach(){this.game.physics.removeComponent(this),this.colliders=[],this.activeCollisions.clear(),super.onDetach()}onBodyEnter(t,e){if(this.event.emit("onBodyEnter",t,e),this.bodyType===l.DYNAMIC){const t=new x(0,0);for(const i of e)t.addSelf(i.mtv);this.entity.position.addSelf(t)}}onBodyExit(t){this.event.emit("onBodyExit",t)}onPhysics(t){if(this.disabled)return;const e=this.entity;switch(this.bodyType){case l.STATIC:break;case l.KINEMATIC:this.velocity.equal(x.ZERO)||e.position.addSelf(this.velocity.multiply(t));break;case l.DYNAMIC:this.velocity.addSelf(this.acceleration.multiply(t)),e.position.addSelf(this.velocity.multiply(t))}}}class dt{constructor(t={}){this.unique=!0,this.event=new K,this.patchMethods=[],this.originalMethods=new Map,this.options=t,this.name=t.name??this.constructor.name}onAttach(t){this.entity=t,this.game=t.game,this.rapid=t.rapid,this.patchEntityMethods()}onDetach(){this.unpatchEntityMethods()}callOriginal(t,...e){const i=this.originalMethods.get(t);if(i)return i(...e);console.warn(`Original method "${t}" not found on entity.`)}patchEntityMethods(){for(const t of this.patchMethods){const e=this[t],i=this.entity[t];"function"==typeof e&&"function"==typeof i&&(this.originalMethods.set(t,i.bind(this.entity)),this.entity[t]=e.bind(this))}}unpatchEntityMethods(){for(const[t,e]of this.originalMethods.entries())this.entity[t]=e;this.originalMethods.clear()}onRenderQueue(t){}onUpdate(t){}onRender(t){}onDispose(){}onPhysics(t){}}class pt{constructor(t,e={}){this.parent=null,this.globalZindex=0,this.localZindex=0,this.transform=new p,this.children=[],this.components=new Map,this.transform.pushIdentity(),this.game=t,this.rapid=t.render,this.tags=e.tags??[],e.position?this.position=e.position:this.position=new x(e.x??0,e.y??0),"number"==typeof e.scale?this.scale=new x(e.scale,e.scale):e.scale?this.scale=e.scale:this.scale=new x(1,1),this.rotation=e.rotation??0}get x(){return this.position.x}get y(){return this.position.y}set x(t){this.position.x=t}set y(t){this.position.y=t}addComponent(t){const e=t.name;if(t.unique&&this.components.has(e))throw new Error(`Component with name '${e}' already exists on entity.`);return this.components.set(e,t),t.onAttach(this),t}removeComponent(t){const e="string"==typeof t?t:t.name,i=this.components.get(e);return!!i&&(i.onDetach(),i.onDispose(),this.components.delete(e),!0)}getComponentByName(t){return this.components.get(t)??null}getComponent(t){for(const e of this.components.values())if(e instanceof t)return e;return null}hasComponent(t){return"string"==typeof t?this.components.has(t):null!==this.getComponent(t)}getScene(){return this.game.getMainScene()}getParentTransform(){return this.parent?this.parent.transform:this.rapid.matrixStack}onRender(t){this.components.forEach((e=>e.onRender(t)))}onRenderQueue(t){this.components.forEach((e=>e.onRenderQueue(t)))}onUpdate(t){this.components.forEach((e=>e.onUpdate(t)))}onPhysics(t){this.components.forEach((e=>e.onPhysics(t)))}onDispose(){this.components.forEach((t=>t.onDispose()))}updateTransform(t=!1){t&&this.parent&&this.parent.updateTransform(t);const e=this.transform,i=this.getParentTransform();e.setTransform(i.getTransform()),e.translate(this.position),e.rotate(this.rotation),e.scale(this.scale)}addChild(t){return t.parent&&t.parent.removeChild(t),t.parent=this,this.children.push(t),this}removeChild(t){const e=this.children.indexOf(t);return e>-1&&(t.parent=null,this.children.splice(e,1)),this}findDescendant(t,e=!0){const i=[];for(const s of this.children){if(t(s)){if(e)return s;i.push(s)}const r=s.findDescendant(t,e);if(e){if(r)return r}else i.push(...r)}return e?null:i}findDescendantByTag(t,e=!1){return this.findDescendant((e=>0!==t.length&&t.every((t=>e.tags.includes(t)))),e)}dispose(){this.postDispose(),this.onDispose(),this.parent&&this.parent.removeChild(this)}processUpdate(t){this.onUpdate(t);for(const e of this.children)e.processUpdate(t)}processPhysics(t){this.onPhysics(t);for(const e of this.children)e.processPhysics(t)}render(t){this.updateTransform(),this.onRenderQueue(t),this.onRender!==pt.prototype.onRender&&t.push(this);for(const e of this.children)e.render(t)}beforeRender(){const t=this.transform;this.rapid.matrixStack.setTransform(t.getTransform())}postDispose(){this.children.forEach((t=>{t.dispose()}))}getMouseLocalPosition(){return this.game.input.getMouseLocal(this)}getMouseGlobalPosition(){return this.game.input.mousePosition}static create(t,e){const i=new pt(t,e);return e.components.forEach((t=>{i.addComponent(t)})),i}}class ft{constructor(t,e){this.textures=new Map,this.width=t,this.height=e}setTile(t,e){e instanceof G&&(e={texture:e}),this.textures.set(t,e)}getTile(t){return this.textures.get(t)}}class mt{constructor(t){this.rapid=t}getOffset(t){return{errorX:(t.error?t.error.x:2)+1,errorY:(t.error?t.error.y:2)+1}}getTileData(t,e){const i=e.shape??n.SQUARE,s=t.width,r=i===n.ISOMETRIC?t.height/2:t.height,o=this.rapid.matrixStack,{errorX:a,errorY:h}=this.getOffset(e),l=new x(0,0),c=new x(this.rapid.width,0),u=new x(0,this.rapid.height),d=new x(this.rapid.width,this.rapid.height),p=o.globalToLocal(l),f=o.globalToLocal(c),m=o.globalToLocal(u),g=o.globalToLocal(d),y=Math.min(p.x,f.x,m.x,g.x),T=Math.max(p.x,f.x,m.x,g.x),w=Math.min(p.y,f.y,m.y,g.y),b=Math.max(p.y,f.y,m.y,g.y),E=new x(Math.floor(y/s)-a,Math.floor(w/r)-h),R=new x(Math.ceil(T/s)+a,Math.ceil(b/r)+h);return{startTile:E,viewportWidth:R.x-E.x,viewportHeight:R.y-E.y}}renderLayer(t,e){const i=e.tileSet,s=[],{startTile:r,viewportWidth:n,viewportHeight:o}=this.getTileData(i,e),a=[];e.ySortCallback&&a.push(...e.ySortCallback);for(let h=0;h<o;h++){const o=h+r.y;if(!(o<0||o>=t.length))for(let h=0;h<n;h++){const n=h+r.x;if(n<0||n>=t[o].length)continue;const l=t[o][n],c=i.getTile(l);if(!c)continue;const u=this.mapToLocal(new x(n,o),e),d=u.y+(c.ySortOffset??0),p=e.eachTile&&e.eachTile(l,n,o)||{};a.push({ySort:d,renderSprite:{...c,x:u.x+(c.x||0),y:u.y+(c.y||0),...p}}),s.push(c)}}e.ySortCallback&&e.ySortCallback.length>0&&a.sort(((t,e)=>t.ySort-e.ySort));for(const h of a)h.render?h.render():h.entity?h.entity.onRender(this.rapid):h.renderSprite&&this.rapid.renderSprite(h.renderSprite);return s}localToMap(t,e){const i=e.tileSet;if(e.shape===n.ISOMETRIC){let e=0,s=0;const r=i.height/2,n=i.width/2;let o=Math.floor(t.y/r);const a=o%2==0;let h=Math.floor(t.x/n);const l=h%2==0,c=t.x%n/n,u=t.y%r/r,d=u<c,p=u<1-c;return a||(o-=1),d&&!l&&a?o-=1:d||!l||a?p&&l&&a?(h-=2,o-=1):p||l||a||(o+=1):(o+=1,h-=2),e=h,s=o,e=Math.floor(h/2),new x(e,s)}return new x(Math.floor(t.x/i.width),Math.floor(t.y/i.height))}mapToLocal(t,e){const i=e.tileSet;if(e.shape===n.ISOMETRIC){let e=new x(t.x*i.width,t.y*i.height/2);return t.y%2!=0&&(e.x+=i.width/2),e}return new x(t.x*i.width,t.y*i.height)}}const gt=class t extends dt{constructor(e){super(e),this.error=new x(t.DEFAULT_ERROR),this.data=[[]],this.ySortCallback=[],this.displayTiles=[],this.patchMethods=["render"],this.error=e.error??new x(t.DEFAULT_ERROR),this.tileSet=e.tileSet,this.shape=e.shape??n.SQUARE,this.eachTile=e.eachTile,this.enableYsort=e.enableYsort??!1}render(t){this.enableYsort?this.onRender!==pt.prototype.onRender&&t.push(this.entity):this.callOriginal("render",t)}setTile(t,e,i){return e<0||e>=this.data.length||t<0||t>=this.data[e].length?(console.warn(`Tilemap.setTile: Coordinates (${t}, ${e}) are out of bounds.`),!1):(this.data[e][t]=i,!0)}getTile(t,e){if(!(e<0||e>=this.data.length||t<0||t>=this.data[e].length))return this.data[e][t]}removeTile(e,i){return this.setTile(e,i,t.EMPTY_TILE)}fill(t,e,i,s,r){const n=e+s,o=i+r;for(let a=i;a<o;a++)for(let i=e;i<n;i++)this.setTile(i,a,t)}setData(t){this.data=t}localToMap(t){this.rapid.tileMap.localToMap(t,this.options)}mapToLocal(t){this.rapid.tileMap.mapToLocal(t,this.options)}onRender(t){const e=[...this.ySortCallback],i=this.entity;this.enableYsort&&i.children.forEach((t=>{e.push({ySort:t.localZindex,entity:t})})),this.displayTiles=t.renderTileMapLayer(this.data,{...this.options,ySortCallback:e})}};gt.DEFAULT_ERROR=0,gt.EMPTY_TILE=-1;class yt{constructor(t){this.projectionDirty=!0,this.matrixStack=new p,this.tileMap=new mt(this),this.light=new w(this),this.defaultColor=new g(255,255,255,255),this.regions=new Map,this.currentMaskType=[],this.currentTransform=[],this.currentFBO=[],this.lastTime=0;const i=(t=>{const e={stencil:!0},i=t.getContext("webgl2",e)||t.getContext("webgl",e);if(!i)throw new Error("Unable to initialize WebGL. Your browser may not support it.");return i})(t.canvas);this.gl=i,this.canvas=t.canvas,this.texture=new k(this,t.antialias??!1),this.maxTextureUnits=i.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),this.width=t.width||this.canvas.width,this.height=t.height||this.canvas.height,this.scaleEnable=t.scaleEnable??!1,this.scaleRadio=t.scaleRadio||e.KEEP,this.devicePixelRatio=t.devicePixelRatio??window.devicePixelRatio??1,this.backgroundColor=t.backgroundColor||new g(255,255,255,255),this.registerBuildInRegion(),this.initWebgl(i),this.updateDisplaySize(this.width,this.height),this.projectionDirty=!1,this.canvas.style.display="block"}updateDisplaySize(t,i){const s=this.width,r=this.height;let n,o,a,h;if(this.scaleEnable){const l=s/r,c=t/i;switch(this.scaleRadio){case e.IGNORE:n=s,o=r,a=t*this.devicePixelRatio,h=i*this.devicePixelRatio;break;case e.KEEP:let u,d;n=s,o=r,c>l?(d=i,u=d*l):(u=t,d=u/l),a=u*this.devicePixelRatio,h=d*this.devicePixelRatio;break;case e.EXPAND:c>l?(o=r,n=r*c):(n=s,o=s/c),a=t*this.devicePixelRatio,h=i*this.devicePixelRatio;break;case e.KEEP_W:n=s,o=s/c,a=t*this.devicePixelRatio,h=i*this.devicePixelRatio;break;case e.KEEP_H:o=r,n=r*c,a=t*this.devicePixelRatio,h=i*this.devicePixelRatio;break;default:n=s,o=r,a=t*this.devicePixelRatio,h=i*this.devicePixelRatio}}else n=s,o=r,a=s*this.devicePixelRatio,h=r*this.devicePixelRatio;this.logicWidth=n,this.logicHeight=o,this.physicsWidth=a,this.physicsHeight=h,this.resizeSize(n,o,a,h,!0)}resizeSize(t,e,i,s,r=!1){this.updateProjection(0,t,e,0),this.gl.viewport(0,0,i,s),this.gl.scissor(0,0,i,s),r&&(this.canvas.width=i,this.canvas.height=s,this.canvas.style.width=i/this.devicePixelRatio+"px",this.canvas.style.height=s/this.devicePixelRatio+"px")}updateProjection(t,e,i,s){this.projection=this.createOrthMatrix(t,e,i,s),this.projectionDirty=!0}initWebgl(t){t.enable(t.BLEND),t.disable(t.DEPTH_TEST),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.enable(t.STENCIL_TEST),t.enable(t.SCISSOR_TEST)}clearTextureUnit(){for(let t=0;t<this.maxTextureUnits;t++)this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this.gl.TEXTURE_2D,null)}registerBuildInRegion(){this.registerRegion("sprite",B),this.registerRegion("graphic",D)}registerRegion(t,e){this.regions.set(t,new e(this))}quitCurrentRegion(){this.currentRegion&&this.currentRegion.hasPendingContent()&&(this.currentRegion.render(),this.currentRegion.exitRegion())}setRegion(t,e){if(t!=this.currentRegionName||this.currentRegion&&this.currentRegion.isShaderChanged(e)){const i=this.regions.get(t);this.quitCurrentRegion(),this.currentRegion=i,this.currentRegionName=t,i.enterRegion(e)}}save(){this.matrixStack.pushMat()}restore(){this.matrixStack.popMat()}withTransform(t){this.save(),t(),this.restore()}startRender(t=!0){this.clear(),t&&this.matrixStack.clear(),this.matrixStack.pushIdentity(),this.currentRegion=void 0,this.currentRegionName=void 0;const e=performance.now(),i=this.lastTime?(e-this.lastTime)/1e3:0;return this.lastTime=e,i}endRender(){this.currentRegion?.render(),this.projectionDirty=!1}render(t){t(this.startRender()),this.endRender()}renderTileMapLayer(t,e){return this.tileMap.renderLayer(t,e instanceof ft?{tileSet:e}:e)}renderSprite(t){const e=t.texture;if(!e||!e.base)return;const{offsetX:i,offsetY:s}=this.startDraw(t,e.width,e.height);this.setRegion("sprite",t.shader),this.currentRegion.renderSprite(e.base.texture,e.width,e.height,e.clipX,e.clipY,e.clipW,e.clipH,i,s,(t.color||this.defaultColor).uint32,t.uniforms,t.flipX,t.flipY),this.afterDraw()}renderTexture(t){t.base&&this.renderSprite({texture:t})}renderLine(t){const e=t.closed?[...t.points,t.points[0]]:t.points,{vertices:i,uv:s}=E({...t,points:e});this.renderGraphic({...t,drawType:this.gl.TRIANGLES,points:i,uv:s})}renderGraphic(t){this.startGraphicDraw(t),t.points.forEach(((e,i)=>{const s=Array.isArray(t.color)?t.color[i]:t.color,r=t.uv?.[i];this.addGraphicVertex(e.x,e.y,r,s)})),this.endGraphicDraw()}startGraphicDraw(t){const{offsetX:e,offsetY:i}=this.startDraw(t);this.setRegion("graphic",t.shader);const s=this.currentRegion;s.startRender(e,i,t.texture,t.uniforms),t.drawType&&(s.drawType=t.drawType)}addGraphicVertex(t,e,i,s){this.currentRegion.addVertex(t,e,i?.x,i?.y,(s||this.defaultColor).uint32)}endGraphicDraw(){this.currentRegion.render(),this.afterDraw()}startDraw(t,e=0,i=0){return this.currentTransform.push(t),this.matrixStack.applyTransform(t,e,i)}afterDraw(){this.currentTransform.length>0&&this.matrixStack.applyTransformAfter(this.currentTransform.pop())}renderRect(t){const{width:e,height:i}=t,s=[new x(0,0),new x(e,0),new x(e,i),new x(0,i)];this.renderGraphic({...t,points:s,drawType:this.gl.TRIANGLE_FAN})}renderCircle(t){const e=t.segments||32,i=t.radius,s=t.color||this.defaultColor,r=[];for(let n=0;n<=e;n++){const t=n/e*Math.PI*2,s=Math.cos(t)*i,o=Math.sin(t)*i;r.push(new x(s,o))}this.renderGraphic({...t,points:r,color:s,drawType:this.gl.TRIANGLE_FAN})}clear(t){const e=this.gl,i=t||this.backgroundColor;e.clearColor(i.r/255,i.g/255,i.b/255,i.a/255),e.clear(e.COLOR_BUFFER_BIT),this.clearMask()}createOrthMatrix(t,e,i,s){return new Float32Array([2/(e-t),0,0,0,0,2/(s-i),0,0,0,0,-1,0,-(e+t)/(e-t),-(s+i)/(s-i),0,1])}drawMask(t=r.Include,e){this.startDrawMask(t),e(),this.endDrawMask()}startDrawMask(t=r.Include){const e=this.gl;this.currentMaskType.push(t),this.setMaskType(t,!0),e.stencilOp(e.KEEP,e.KEEP,e.REPLACE),e.colorMask(!1,!1,!1,!1)}endDrawMask(){const t=this.gl;this.quitCurrentRegion(),t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.colorMask(!0,!0,!0,!0),this.setMaskType(this.currentMaskType.pop()??r.Include,!1)}setMaskType(t,e=!1){const i=this.gl;if(this.quitCurrentRegion(),e)this.clearMask(),i.stencilFunc(i.ALWAYS,1,255);else switch(t){case r.Include:i.stencilFunc(i.EQUAL,1,255);break;case r.Exclude:i.stencilFunc(i.NOTEQUAL,1,255)}}clearMask(){const t=this.gl;this.quitCurrentRegion(),t.clearStencil(0),t.clear(t.STENCIL_BUFFER_BIT),t.stencilFunc(t.ALWAYS,1,255)}createCostumShader(t,e,i,s=0){return F.createCostumShader(this,t,e,i,s)}startFBO(t,e=this.defaultColor){this.quitCurrentRegion(),t.bind(e),this.clearTextureUnit(),this.resizeSize(t.width,t.height,t.width,t.height),this.updateProjection(0,t.width,0,t.height),this.save(),this.matrixStack.identity(),this.currentFBO.push(t)}endFBO(){if(this.currentFBO.length>0){const t=this.currentFBO.pop();this.quitCurrentRegion(),t.unbind(),this.clearTextureUnit(),this.resizeSize(this.logicWidth,this.logicHeight,this.physicsWidth,this.physicsHeight),this.restore()}}drawToFBO(t,e){this.startFBO(t),e(),this.endFBO()}setBlendMode(t){switch(t){case a.Additive:this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE);break;case a.Subtractive:this.gl.blendFunc(this.gl.ZERO,this.gl.ONE_MINUS_SRC_COLOR);break;case a.Mix:this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA)}}drawLightShadowMask(t){this.startDrawMask(t.type||r.Exclude);this.light.createLightShadowMaskPolygon(t.occlusion,t.lightSource,t.baseProjectionLength).forEach((t=>{this.renderGraphic({points:t,color:g.Black})})),this.endDrawMask()}cssToGameCoords(t,e){const i=t instanceof x?t:new x(t,e),s=this.canvas.getBoundingClientRect(),r=i.x/s.width,n=i.y/s.height,o=r*this.logicWidth,a=n*this.logicHeight;return new x(o,a)}gameToCssCoords(t,e){const i=t instanceof x?t:new x(t,e??0),s=this.canvas.getBoundingClientRect(),r=i.x/this.logicWidth,n=i.y/this.logicHeight,o=r*s.width,a=n*s.height;return new x(o,a)}}const xt=!0;class Tt{constructor(t,e){this.life=0,this.datas={},this.emitter=t,this.rapid=t.rapid,this.options=e,e.texture instanceof G?this.texture=e.texture:e.texture instanceof Array&&e.texture[0]instanceof Array?this.texture=T.pickWeight(e.texture):e.texture instanceof Array&&(this.texture=T.pick(e.texture)),this.collider=new rt(t.entity,e.colliderRaduis??10),this.collider.extraData=this,this.maxLife=T.scalarOrRange(e.life,1),this.datas={speed:this.processAttribute(e.animation.speed,0),rotation:this.processAttribute(e.animation.rotation,0),scale:this.processAttribute(e.animation.scale,1),color:this.processAttribute(e.animation.color,g.White),velocity:this.processAttribute(e.animation.velocity,x.ZERO),acceleration:this.processAttribute(e.animation.acceleration,x.ZERO)},this.position=x.ZERO,this.initializePosition()}processAttribute(t,e){if(!t)return{value:e};if("object"==typeof(i=t)&&null!==i&&Object.getPrototypeOf(i)===Object.prototype){const i=t,s=T.scalarOrRange(i.start,e),r=T.scalarOrRange(i.end||s,e);return{delta:i.delta??this.getDelta(s,r,this.maxLife),value:s,damping:i.damping}}return this.processAttribute({start:t},e);var i}updateDamping(t){for(const e of Object.values(this.datas))if(e.damping){const i=e.value,s=Math.pow(e.damping,t);"number"==typeof i?e.value*=s:i.multiply&&(e.value=i.multiply(s))}}updateDelta(t){const e=this.datas;for(const s of Object.values(e))if(s.delta){const e=s.value;"number"==typeof e?s.value+=t*s.delta:e.add&&(s.value=e.add(s.delta.multiply(t)))}e.color.value.clamp(),e.velocity.value=e.velocity.value.add(e.acceleration.value.multiply(t));const i=x.fromAngle(e.rotation.value).multiply(e.speed.value*t);this.position=this.position.add(i).add(e.velocity.value.multiply(t))}getDelta(t,e,i){return 0===i?t:"number"==typeof t&&"number"==typeof e?(e-t)/i:t instanceof x&&e instanceof x||t instanceof g&&e instanceof g?e.subtract(t).divide(i):t}updateOffset(){if(this.options.localSpace)this.collider.offset=this.position;else{const t=this.emitter.entity.transform.getGlobalPosition();this.collider.offset=t.subtract(this.position)}}update(t){return this.life+=t,!(this.life>=this.maxLife)&&(this.updateDamping(t),this.updateDelta(t),!0)}render(){this.rapid.renderSprite({...this.options,position:this.position,scale:this.datas.scale.value,rotation:this.datas.rotation.value,color:this.datas.color.value,texture:this.texture})}initializePosition(){switch(this.options.emitShape){case h.POINT:this.position=x.ZERO;break;case h.CIRCLE:const t=Math.random()*Math.PI*2,e=(this.options.emitRadius||0)*Math.sqrt(Math.random());this.position=new x(Math.cos(t)*e,Math.sin(t)*e);break;case h.RECT:this.position=new x((Math.random()-.5)*(this.options.emitRect?.width||0),(Math.random()-.5)*(this.options.emitRect?.height||0))}this.options.localSpace||this.position.addSelf(this.emitter.entity.transform.getGlobalPosition())}}return t.ArrayType=c,t.BaseTexture=O,t.BlendMode=a,t.Body=ut,t.BodyType=l,t.Camera=class extends dt{constructor(t={}){super(t),this.patchMethods=["updateTransform"],this.enable=!1,this.center=!1,this.positionSmoothingSpeed=0,this.rotationSmoothingSpeed=0;const e=this.entity;this.center=t.center??!0,this.positionSmoothingSpeed=t.positionSmoothingSpeed??0,this.rotationSmoothingSpeed=t.rotationSmoothingSpeed??0,this._currentRenderPosition=e.position.clone(),this._currentRenderRotation=e.rotation,this.setEnable(t.enable??!1)}setEnable(t){this.enable=t,t?this.game.setMainCamera(this):this.game.mainCamera===this&&this.game.setMainCamera(null)}onAttach(t){super.onAttach(t)}onUpdate(t){super.onUpdate(t);const e=this.entity;if(this.positionSmoothingSpeed>0){const i=1-Math.exp(-this.positionSmoothingSpeed*t);this._currentRenderPosition.lerp(e.position,i)}else this._currentRenderPosition.copy(e.position);if(this.rotationSmoothingSpeed>0){const i=1-Math.exp(-this.rotationSmoothingSpeed*t);let s=e.rotation-this._currentRenderRotation;for(;s<-Math.PI;)s+=2*Math.PI;for(;s>Math.PI;)s-=2*Math.PI;this._currentRenderRotation+=s*i}else this._currentRenderRotation=e.rotation}updateTransform(){const t=this.entity,e=this.rapid,i=t.getParentTransform(),s=t.transform;s.setTransform(i.getTransform()),s.translate(this._currentRenderPosition),s.rotate(this._currentRenderRotation),s.scale(t.scale);const r=s.getInverse();if(this.center){const t=e.logicWidth/2,i=e.logicHeight/2;r[4]=r[0]*t+r[2]*i+r[4],r[5]=r[1]*t+r[3]*i+r[5]}t.transform.setTransform(r)}getTransform(){return this.entity.transform.getTransform()}},t.CanvasLayer=class extends dt{constructor(t){super(t),this.patchMethods=["updateTransform"]}onAttach(t){super.onAttach(t)}updateTransform(){this.entity.transform.identity()}},t.CircleCollider=rt,t.Collider=st,t.Color=g,t.Component=dt,t.DynamicArrayBuffer=u,t.FrameBufferObject=j,t.GLShader=F,t.Game=class{constructor(t){this.mainScene=null,this.isRunning=!1,this.lastTime=0,this.tweens=[],this.timers=[],this.mainCamera=null,this.renderQueue=[],this.worldTransform=new p,this.render=new yt(t),this.input=new Z(this.render),this.asset=new V(this),this.audio=new Q,this.physics=new ct(this),this.texture=this.render.texture}getMainScene(){return this.mainScene}setMainCamera(t){this.mainCamera=t}switchScene(t){this.mainScene&&this.mainScene.dispose(),this.mainScene=t,t.create()}start(){this.isRunning||(this.isRunning=!0,this.lastTime=performance.now(),this.gameLoop())}stop(){this.isRunning=!1}addEntityRenderQueue(t){this.renderQueue.push(t)}gameLoop(){if(!this.isRunning)return;const t=performance.now(),e=(t-this.lastTime)/1e3;this.lastTime=t,this.render.startRender(),this.mainScene&&(this.mainCamera&&this.mainCamera.enable&&this.render.matrixStack.setTransform(this.mainCamera.getTransform()),this.worldTransform.setTransform(this.render.matrixStack.getTransform()),this.mainScene.processUpdate(e),this.mainScene.processPhysics(e),this.mainScene.render(this.renderQueue),this.renderQueue.sort(((t,e)=>{const i=t.parent&&t.parent===e.parent,s=t.globalZindex-e.globalZindex;return 0!==s?s:i?t.localZindex-e.localZindex:0})),this.renderQueue.forEach((t=>{t.beforeRender(),t.onRender(this.render)})),this.renderQueue.length=0),this.render.endRender(),this.input.updateNextFrame(),this.updateTweens(e),this.updateTimers(e),requestAnimationFrame(this.gameLoop.bind(this))}destroy(){this.audio.destroy(),this.input.destroy()}createTimer(t,e=!1){const i=new it(t,e);return this.timers.push(i),i.start(),i}updateTimers(t){for(const e of this.timers)e.update(t);this.timers=this.timers.filter((t=>!t.isFinished))}createTween(t,e,i,s,r=et.Linear){const n=new J(t,e,i,s,r);return this.tweens.push(n),n.start(),n}updateTweens(t){for(const e of this.tweens)e.update(t);this.tweens=this.tweens.filter((t=>!t.isFinished))}},t.GameObject=pt,t.InputManager=Z,t.Label=class extends dt{constructor(t){super(t),this.text=new W(this.game.render,t)}onRender(t){t.renderSprite({texture:this.text})}setText(t){this.text.setText(t)}},t.LineTextureMode=i,t.MaskType=r,t.MathUtils=class{static deg2rad(t){return t*(Math.PI/180)}static rad2deg(t){return t/(Math.PI/180)}static normalizeDegrees(t){return(t%360+360)%360}},t.MatrixStack=p,t.PartcileBody=class extends ut{constructor(t){super(t),this.particle=t.particle}onUpdate(t){super.onUpdate(t),this.colliders.length=0,this.particle.particles.forEach((t=>{t&&(t.updateOffset(),t.collider.extraData=t,this.colliders.push(t.collider))}))}onBodyEnter(t,e){for(const i of e){i.colliderA.extraData.position.addSelf(i.mtv)}}},t.Particle=Tt,t.ParticleEmitter=class extends dt{constructor(t){super(t),this.particles=[],this.emitting=!1,this.emitTimer=0,this.emitRate=10,this.emitTime=0,this.emitTimeCounter=0,this.localSpace=xt,this.emitRate=t.emitRate??10,this.emitTime=t.emitTime??0,this.localSpace=t.localSpace??xt}setEmitRate(t){this.emitRate=t}setEmitTime(t){this.emitTime=t}start(){this.emitting=!0,this.emitTimer=0,this.emitTimeCounter=0}stop(){this.emitting=!1}clear(){this.particles=[],this.emitTimer=0,this.emitTimeCounter=0}emit(t){this.entity;const e=Math.floor(Math.min(t,(this.options.maxParticles||1/0)-this.particles.length));for(let i=0;i<e;i++){const t=new Tt(this,{...this.options,localSpace:this.localSpace});this.particles.unshift(t)}}onUpdate(t){if(this.emitting&&this.emitRate>0)if(this.emitTime>0)for(this.emitTimeCounter+=t;this.emitTimeCounter>=this.emitTime;)this.emit(this.emitRate),this.emitTimeCounter-=this.emitTime;else{this.emitTimer+=t;const e=1/this.emitRate;for(;this.emitTimer>=e;)this.emit(1),this.emitTimer-=e}for(let e=this.particles.length-1;e>=0;e--)this.particles[e].update(t)||this.particles.splice(e,1)}onRender(){if(this.rapid.save(),!this.localSpace){const t=this.game.worldTransform;this.rapid.matrixStack.setTransform(t.getTransform())}for(const t of this.particles)t.render();this.rapid.restore()}getParticleCount(){return this.particles.length}isActive(){return this.emitting||this.particles.length>0}oneShot(){this.emit(this.emitRate)}},t.ParticleShape=h,t.PhysicsManager=ct,t.PointCollider=class extends rt{constructor(t,e){super(t,0,e)}},t.PolygonCollider=nt,t.Random=T,t.Rapid=yt,t.SCALEFACTOR=z,t.ScaleRadio=e,t.Scene=class extends pt{create(){}},t.ShaderType=o,t.Sprite=class extends dt{constructor(t={}){super(t),this.animations=new Map,this.currentAnimation=null,this.currentFrame=0,this.frameTimer=0,this.isPlaying=!1,this.texture=t.texture??null,this.flipX=t.flipX??!1,this.flipY=t.flipY??!1,this.color=t.color??g.White,this.offset=t.offset??x.ZERO,t.animations&&this.setAnimations(t.animations)}setAnimations(t){this.animations=new Map(Object.entries(t))}addAnimation(t,e,i=10,s=!0){this.animations.set(t,{name:t,frames:e,fps:i,loop:s})}play(t,e=!1){const i=this.animations.get(t);i?this.currentAnimation!==i||e?(this.currentAnimation=i,this.currentFrame=0,this.frameTimer=0,this.isPlaying=!0,this.texture=this.currentAnimation.frames[this.currentFrame]):this.isPlaying||(this.isPlaying=!0):console.warn(`Animation "${t}" not found.`)}stop(){this.isPlaying=!1}onUpdate(t){if(!this.isPlaying||!this.currentAnimation)return;const e=1/this.currentAnimation.fps;for(this.frameTimer+=t;this.frameTimer>=e;)if(this.frameTimer-=e,this.currentFrame++,this.currentFrame>=this.currentAnimation.frames.length){if(!this.currentAnimation.loop){this.currentFrame=this.currentAnimation.frames.length-1,this.isPlaying=!1;break}this.currentFrame=0}this.texture=this.currentAnimation.frames[this.currentFrame]}onRender(t){this.texture&&t.renderSprite({texture:this.texture,flipX:this.flipX,flipY:this.flipY,offset:this.offset,color:this.color})}},t.Text=W,t.Texture=G,t.TextureCache=k,t.TextureWrapMode=s,t.TileMapRender=mt,t.TileSet=ft,t.TilemapBody=class extends ut{constructor(t){super(t),this.tilemap=t.tilemap}onUpdate(t){super.onUpdate(t),this.colliders.length=0,this.tilemap.displayTiles.forEach((t=>{Array.isArray(t.colliders)?this.colliders.push(...t.colliders):t.colliders&&this.colliders.push(t.colliders)}))}},t.TilemapShape=n,t.Uniform=class{constructor(t){this.isDirty=!1,this.data=t}setUniform(t,e){this.data[t]!=e&&(this.isDirty=!0),this.data[t]=e}clearDirty(){this.isDirty=!1}getUnifromNames(){return Object.keys(this.data)}bind(t,e,i,s){if(!i)return;const r=this.data[e];if("number"==typeof r)t.uniform1f(i,r);else if(Array.isArray(r))switch(r.length){case 1:Number.isInteger(r[0])?t.uniform1i(i,r[0]):t.uniform1f(i,r[0]);break;case 2:Number.isInteger(r[0])?t.uniform2iv(i,r):t.uniform2fv(i,r);break;case 3:Number.isInteger(r[0])?t.uniform3iv(i,r):t.uniform3fv(i,r);break;case 4:Number.isInteger(r[0])?t.uniform4iv(i,r):t.uniform4fv(i,r);break;case 9:t.uniformMatrix3fv(i,!1,r);break;case 16:t.uniformMatrix4fv(i,!1,r);break;default:console.error(`Unsupported uniform array length for ${e}:`,r.length)}else if("boolean"==typeof r)t.uniform1i(i,r?1:0);else if(r.base?.texture){const e=s.useTexture(r.base.texture)[0];t.uniform1i(i,e)}else console.error(`Unsupported uniform type for ${e}:`,typeof r)}},t.Vec2=x,t.WebglBufferArray=d,t.WebglElementBufferArray=f,t.checkCollision=lt,t.graphicAttributes=U,t.spriteAttributes=_,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),t}({});
